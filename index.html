<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Experiment</title>
  <!-- viewport setup -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- lab.js library and experiment code -->
  <!-- lab.js library code -->
  <script src="lib/lab.js" data-labjs-script="library"></script>
  <script src="lib/lab.fallback.js" data-labjs-script="fallback"></script>
  <link rel="stylesheet" href="lib/lab.css">
  <!-- study code and styles -->
  <script src="script.js" defer="true"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- If you'd rather have a container with a fixed width
       and variable height, try removing the fullscreen class below -->
  <div class="container fullscreen" data-labjs-section="main">
    <main class="content-vertical-center content-horizontal-center">
      <div>
        <h2>Loading Experiment</h2>
        <p>The experiment is loading and should start in a few seconds</p>
      </div>
    </main>
  </div>


<script>
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxloi-Zqdkg_PTBcSAwywgEBJaidsfEzc-X7yhJtXBSSTZyQUXJOYPVmOgbGX869bD8/exec';

  // 2) Stable participant ID (kept in localStorage)
  function getParticipantId() {
    let pid = localStorage.getItem('pid');
    if (!pid) {
      pid = Math.random().toString(36).slice(2, 10);
      localStorage.setItem('pid', pid);
    }
    return pid;
  }

  (async function sendIfQueryParams() {
    const qs = new URLSearchParams(window.location.search);
    if (!qs.toString()) return;                  // nothing to send

    // 3) Convert ?rate_1=1&pick_1=C... -> { rate_1:"1", pick_1:"C", ... }
    const row = Object.fromEntries(qs.entries());

    try {
      const resp = await fetch(WEBAPP_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          participantId: getParticipantId(),
          rows: [row] // one wide row with all fields
        })
      });
      const text = await resp.text();
      console.log('Upload response:', text);
    } catch (e) {
      console.error('Upload failed:', e);
    } finally {
      // window.history.replaceState({}, '', window.location.pathname);

      history.replaceState({}, '', location.pathname);
      window.location.href = '/thanks.html';
    }
  })();
</script>

</body>
</html>
